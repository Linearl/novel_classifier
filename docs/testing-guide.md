# 测试规范 (Testing Guide)

## 1. 概述

本规范旨在为“小说整理工具”项目定义一套完整的测试策略，确保软件的质量、稳定性和可靠性。所有开发者在贡献代码时，都应遵循本规范的要求进行测试。

## 2. 测试理念

- **质量是团队共同的责任**: 每个开发者都有责任确保其代码经过充分测试。
- **测试左移**: 在开发周期早期就介入测试，尽可能早地发现和修复缺陷。
- **自动化优先**: 凡是能自动化的测试都应编写成自动化脚本，以提高回归测试的效率。
- **分层测试**: 采用测试金字塔模型，重点投入单元测试，辅以必要的集成测试和端到端测试。

## 3. 测试类型

### 3.1. 单元测试 (Unit Tests)

- **目标**: 验证单个函数、方法或类的逻辑是否正确。
- **位置**: `tests/` 目录下，文件名以 `test_` 开头。
- **要求**:
  - 快速、独立、可重复。
  - 不应涉及文件I/O、网络请求或数据库连接等外部依赖。使用模拟（Mocking）和打桩（Stubbing）来隔离被测单元。
  - 每个测试用例应只关注一个特定的功能点。

### 3.2. 集成测试 (Integration Tests)

- **目标**: 验证多个模块或组件协同工作时是否符合预期。
- **位置**: `tests/` 目录下，可放在子目录如 `tests/integration/` 中。
- **示例**:
  - 测试 `workflow_manager.py` 能否正确调用 `encoding_fix.py` 和 `file_import.py` 并完成一个完整的文件处理流程。
  - 测试GUI的按钮点击后，是否能正确触发后端的 `core` 逻辑。
- **要求**:
  - 模拟真实的使用场景，但可以控制在有限的环境中（例如，使用特定的测试配置文件和小说库子集）。

### 3.3. 端到端测试 (End-to-End Tests)

- **目标**: 从用户的角度出发，验证整个应用程序（包括GUI）作为一个整体是否功能正常。
- **当前阶段**: 在项目早期，端到端测试主要通过 **手动测试** 完成。开发者在完成一个功能或修复一个Bug后，应手动运行GUI，模拟用户操作，验证其正确性。
- **手动测试清单 (示例)**:
  1. 启动 `novel_gui.py`。
  2. 选择一个包含测试文件的导入目录。
  3. 点击“开始导入”，观察日志和文件移动结果。
  4. 选择一个包含编码问题文件的目录。
  5. 点击“编码修复”，观察进度条、日志和文件内容变化。
  6. ...（根据具体功能补充）

## 4. 测试工具与框架

- **测试框架**: `pytest` - 用于编写和执行单元测试与集成测试。
- **代码覆盖率**: `pytest-cov` - 用于衡量测试覆盖的范围。
- **模拟工具**: `unittest.mock` - Python内置的模拟库，用于隔离测试单元。

## 5. 如何运行测试

### 5.1. 运行所有测试

在项目根目录下执行：

```bash
pytest
```

### 5.2. 运行特定文件的测试

```bash
pytest tests/test_encoding_fix.py
```

### 5.3. 查看测试覆盖率

```bash
pytest --cov=.
```

这将生成一份详细的报告，显示哪些代码行被测试覆盖，哪些没有。

## 6. 编写新测试的指南

- **清晰的命名**: 测试函数名应清晰地描述它在测试什么，例如 `test_rename_file_removes_special_characters`。
- **Arrange-Act-Assert (3A模式)**:
  - **Arrange**: 设置测试的初始状态（如创建对象、准备测试数据）。
  - **Act**: 执行被测试的代码。
  - **Assert**: 验证执行结果是否符合预期。
- **覆盖边界情况**: 除了正常的“快乐路径”，还应测试异常输入、空值、错误格式等边界情况。
- **Bug修复与测试**: 在修复一个Bug之前，先编写一个能够稳定复现该Bug的测试用例。当测试通过时，证明Bug已被修复。

## 7. 持续集成 (CI)

（未来规划）

当项目引入CI/CD流程后，所有提交到 `develop` 和 `main` 分支的代码都将自动触发测试流水线。流水线将执行以下任务：

1. 安装依赖。
2. 运行 `flake8` 进行代码风格检查。
3. 运行所有 `pytest` 测试。
4. （可选）生成并发布测试覆盖率报告。

**只有当所有检查和测试都通过时，代码才允许被合并。**

---

*本规范是保证项目质量的基石，请严格遵守。*
