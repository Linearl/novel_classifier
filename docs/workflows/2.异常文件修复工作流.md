# å¼‚å¸¸æ–‡ä»¶åä¿®å¤å·¥ä½œæµ

## æ¦‚è¿°

æœ¬å·¥ä½œæµä¸“é—¨å¤„ç†å‘½åå¼‚å¸¸çš„å°è¯´æ–‡ä»¶ï¼ŒåŒ…æ‹¬æ•°å­—å‘½åï¼ˆå¦‚ï¼š1.txtã€123.TXTç­‰ï¼‰å’Œå…¶ä»–ä¸è§„èŒƒå‘½åçš„æ–‡ä»¶ã€‚é€šè¿‡ç³»ç»ŸåŒ–çš„ç¼–ç ä¿®å¤ã€å†…å®¹åˆ†æå’Œæ™ºèƒ½é‡å‘½åï¼Œå°†æ–‡ä»¶è½¬æ¢ä¸ºè§„èŒƒçš„ã€Šä¹¦å-ä½œè€…ã€‹.txtæ ¼å¼ã€‚

## ğŸ¯ å·¥ä½œæµç¨‹ç›®æ ‡

- **å…¨é¢ç¼–ç ä¿®å¤**ï¼šæ£€æŸ¥å¹¶ä¿®å¤æ‰€æœ‰æ–‡ä»¶çš„ç¼–ç é—®é¢˜
- **è¯†åˆ«å¼‚å¸¸å‘½å**ï¼šç­›é€‰å‡ºéœ€è¦é‡å‘½åçš„æ–‡ä»¶
- **æ™ºèƒ½ä¹¦åæå–**ï¼šåŸºäºå†…å®¹åˆ†ææå–çœŸå®ä¹¦åå’Œä½œè€…ä¿¡æ¯
- **è§„èŒƒåŒ–å‘½å**ï¼šç»Ÿä¸€è½¬æ¢ä¸ºã€Šä¹¦å-ä½œè€…ã€‹.txtæ ¼å¼
- **è´¨é‡éªŒè¯**ï¼šç¡®ä¿é‡å‘½åç»“æœçš„åˆç†æ€§å’Œå‡†ç¡®æ€§

## ğŸ“‹ é€‚ç”¨åœºæ™¯

### âœ… æ¨èä½¿ç”¨æƒ…å†µ
- æ•°å­—å‘½åçš„å°è¯´æ–‡ä»¶ï¼ˆ1.txtã€123.TXTç­‰ï¼‰
- ä¹±ç æˆ–ä¸è§„èŒƒçš„æ–‡ä»¶å
- æ‰¹é‡ä¸‹è½½çš„æœªæ•´ç†æ–‡ä»¶
- ç¼–ç æ··ä¹±çš„æ–‡ä»¶é›†åˆ

### âŒ ä¸é€‚ç”¨æƒ…å†µ
- å·²ç»è§„èŒƒå‘½åçš„æ–‡ä»¶ï¼ˆã€Šä¹¦å-ä½œè€…ã€‹.txtæ ¼å¼ï¼‰
- éæ–‡æœ¬æ–‡ä»¶ï¼ˆå›¾ç‰‡ã€è§†é¢‘ç­‰ï¼‰
- æ–‡ä»¶å†…å®¹ä¸¥é‡æŸåçš„æ–‡ä»¶

## ğŸ› ï¸ æ‰€éœ€å·¥å…·

### æ ¸å¿ƒå·¥å…·
- `encoding_fixer.py` - ç¼–ç ä¿®å¤å·¥å…·
- `novel_renamer.py` - æ™ºèƒ½é‡å‘½åå·¥å…·
- `txt_preview.py` - æ–‡ä»¶å†…å®¹é¢„è§ˆå·¥å…·

### è¾…åŠ©å·¥å…·
- `file` å‘½ä»¤ - æ–‡ä»¶ç±»å‹å’Œç¼–ç æ£€æµ‹

## ğŸš€ å®Œæ•´å·¥ä½œæµç¨‹

### æ­¥éª¤1ï¼šå…¨é¢ç¼–ç æ£€æŸ¥å’Œä¿®å¤

```bash
# è®¾ç½®å·¥ä½œç›®å½•
cd "/Volumes/980pro/å¾…æ•´ç†"

# æ£€æŸ¥Pythonç¯å¢ƒ
echo "=== ç¯å¢ƒæ£€æŸ¥ ==="
python --version
python -c "import chardet; print('chardetåº“å¯ç”¨')"

# æ­¥éª¤1.1ï¼šæ‰«ææ‰€æœ‰txtæ–‡ä»¶
echo "=== æ‰«ææ‰€æœ‰txtæ–‡ä»¶ ==="
all_txt_files=($(find . -name "*.txt" -o -name "*.TXT" | sort))
echo "å‘ç° ${#all_txt_files[@]} ä¸ªtxtæ–‡ä»¶"

# æ­¥éª¤1.2ï¼šæ£€æŸ¥ç¼–ç çŠ¶æ€
echo ""
echo "=== æ£€æŸ¥æ–‡ä»¶ç¼–ç çŠ¶æ€ ==="
encoding_problem_files=()

for file in "${all_txt_files[@]}"; do
    if [ -f "$file" ]; then
        # ä½¿ç”¨fileå‘½ä»¤æ£€æµ‹ç¼–ç 
        file_info=$(file "$file")
        
        # å¦‚æœä¸æ˜¯UTF-8ç¼–ç ï¼ŒåŠ å…¥é—®é¢˜æ–‡ä»¶åˆ—è¡¨
        if ! echo "$file_info" | grep -q "UTF-8"; then
            encoding_problem_files+=("$file")
            echo "ç¼–ç å¼‚å¸¸: $file"
            echo "  æ£€æµ‹ç»“æœ: $file_info"
        fi
    fi
done

echo ""
echo "ç¼–ç æ£€æŸ¥å®Œæˆï¼š"
echo "  æ€»æ–‡ä»¶æ•°: ${#all_txt_files[@]}"
echo "  ç¼–ç é—®é¢˜æ–‡ä»¶: ${#encoding_problem_files[@]}"

# æ­¥éª¤1.3ï¼šæ‰¹é‡ä¿®å¤ç¼–ç é—®é¢˜
if [ ${#encoding_problem_files[@]} -gt 0 ]; then
    echo ""
    echo "=== å¼€å§‹æ‰¹é‡ç¼–ç ä¿®å¤ ==="
    
    # ä½¿ç”¨encoding_fixer.pyä¿®å¤ç¼–ç 
    python encoding_fixer.py "${encoding_problem_files[@]}"
    
    echo ""
    echo "=== éªŒè¯ç¼–ç ä¿®å¤ç»“æœ ==="
    for file in "${encoding_problem_files[@]}"; do
        if [ -f "$file" ];then
            new_encoding=$(file "$file")
            if echo "$new_encoding" | grep -q "UTF-8"; then
                echo "âœ… ä¿®å¤æˆåŠŸ: $(basename "$file")"
            else
                echo "âŒ ä¿®å¤å¤±è´¥: $(basename "$file")"
            fi
        fi
    done
else
    echo ""
    echo "âœ… æ‰€æœ‰æ–‡ä»¶ç¼–ç æ­£å¸¸ï¼Œæ— éœ€ä¿®å¤"
fi
```

### æ­¥éª¤2ï¼šç­›é€‰å‘½åå¼‚å¸¸æ–‡ä»¶å¹¶è‡ªåŠ¨é‡å‘½å

```bash
# æ­¥éª¤2.1ï¼šè¯†åˆ«å‘½åå¼‚å¸¸æ–‡ä»¶
echo ""
echo "=== ç­›é€‰å‘½åå¼‚å¸¸æ–‡ä»¶ ==="

abnormal_files=()

# æ‰«æçº¯æ•°å­—å‘½åæ–‡ä»¶ï¼ˆå¦‚ï¼š123.txtï¼Œè€Œéã€Š18å²çš„å°‘å¹´ã€‹.txtï¼‰
# ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼ç¡®ä¿æ–‡ä»¶åæ˜¯çº¯æ•°å­—
digital_files=($(find . -type f -regex ".*\/[0-9]+\.txt" -o -regex ".*\/[0-9]+\.TXT" | grep -v "ã€Š" | sort))
abnormal_files+=("${digital_files[@]}")

# æ‰«æå…¶ä»–å¯èƒ½çš„å¼‚å¸¸å‘½åï¼ˆå¯æ ¹æ®éœ€è¦æ‰©å±•ï¼‰
# ä¾‹å¦‚ï¼šå•å­—ç¬¦æ–‡ä»¶åã€ç‰¹æ®Šå­—ç¬¦æ–‡ä»¶åç­‰
single_char_files=($(find . -name "?.txt" -o -name "?.TXT" | grep -v "ã€Š" | sort))
abnormal_files+=("${single_char_files[@]}")

echo "å‘ç°å‘½åå¼‚å¸¸æ–‡ä»¶:"
echo "  çº¯æ•°å­—å‘½åæ–‡ä»¶: ${#digital_files[@]} ä¸ª"
echo "  å•å­—ç¬¦å‘½åæ–‡ä»¶: ${#single_char_files[@]} ä¸ª"
echo "  å¼‚å¸¸æ–‡ä»¶æ€»æ•°: ${#abnormal_files[@]} ä¸ª"

# æ­¥éª¤2.2ï¼šä½¿ç”¨å·¥å…·è‡ªåŠ¨æå–ä¹¦åå¹¶é‡å‘½å
if [ ${#abnormal_files[@]} -gt 0 ]; then
    echo ""
    echo "=== å¯åŠ¨è‡ªåŠ¨é‡å‘½åæµç¨‹ ==="
    
    # åˆ›å»ºä¸´æ—¶å·¥ä½œç›®å½•
    temp_dir="temp_renaming"
    mkdir -p "$temp_dir"
    
    # å¤åˆ¶å¼‚å¸¸æ–‡ä»¶åˆ°ä¸´æ—¶ç›®å½•è¿›è¡Œå¤„ç†
    for file in "${abnormal_files[@]}"; do
        if [ -f "$file" ];then
            cp "$file" "$temp_dir/"
        fi
    done
    
    # åœ¨ä¸´æ—¶ç›®å½•ä¸­è¿è¡Œé‡å‘½åå·¥å…·
    cd "$temp_dir"
    echo "æ­£åœ¨ä¸´æ—¶ç›®å½•ä¸­å¤„ç† $(ls *.txt *.TXT 2>/dev/null | wc -l) ä¸ªæ–‡ä»¶..."
    
    # ä½¿ç”¨æ”¹è¿›ç‰ˆçš„ä¸´æ—¶é‡å‘½åå·¥å…·
    python ../tools/temp_renamer.py .
    
    # ç»Ÿè®¡é‡å‘½åç»“æœ
    renamed_files=($(ls ã€Š*ã€‹.txt 2>/dev/null))
    remaining_files=($(ls [0-9]*.txt [0-9]*.TXT ?.txt ?.TXT 2>/dev/null | grep -v "ã€Š"))
    
    echo ""
    echo "è‡ªåŠ¨é‡å‘½åç»“æœ:"
    echo "  æˆåŠŸé‡å‘½å: ${#renamed_files[@]} ä¸ªæ–‡ä»¶"
    echo "  ä»éœ€å¤„ç†: ${#remaining_files[@]} ä¸ªæ–‡ä»¶"
    
    # è¿”å›ä¸»ç›®å½•
    cd ..
else
    echo ""
    echo "âœ… æœªå‘ç°å‘½åå¼‚å¸¸æ–‡ä»¶"
fi
```

### æ­¥éª¤3ï¼šæ£€æŸ¥é‡å‘½åç»“æœçš„åˆç†æ€§

```bash
# æ­¥éª¤3.1ï¼šæ£€æŸ¥é‡å‘½åæ–‡ä»¶çš„åˆç†æ€§
echo ""
echo "=== æ£€æŸ¥é‡å‘½åæ–‡ä»¶çš„åˆç†æ€§ ==="

cd "temp_renaming" 2>/dev/null || exit

unreasonable_files=()
reasonable_files=()

# åˆ›å»ºä¸€ä¸ªä¸´æ—¶æ–‡ä»¶å­˜å‚¨éœ€è¦æ‰‹åŠ¨å¤„ç†çš„æ–‡ä»¶ä¿¡æ¯
unreasonable_file_list="unreasonable_files.txt"
> "$unreasonable_file_list"  # æ¸…ç©ºæˆ–åˆ›å»ºæ–‡ä»¶

# éå†æ‰€æœ‰é‡å‘½åçš„æ–‡ä»¶
for file in ã€Š*ã€‹.txt; do
    if [ -f "$file" ] && [[ ! "$file" =~ ^\._ ]]; then  # æ’é™¤Macç³»ç»Ÿçš„å…ƒæ•°æ®æ–‡ä»¶
        book_title=$(echo "$file" | sed 's/ã€Š\(.*\)ã€‹\.txt/\1/')
        
        echo "æ£€æŸ¥æ–‡ä»¶: $file"
        echo "æå–çš„ä¹¦å: $book_title"
        
        unreasonable=false
        reason=""
        
        # æ£€æŸ¥ä¹¦åæ˜¯å¦è¿‡çŸ­ï¼ˆå°‘äº2ä¸ªå­—ç¬¦ï¼‰
        if [ ${#book_title} -lt 2 ]; then
            echo "  âŒ ä¹¦åè¿‡çŸ­"
            unreasonable=true
            reason="ä¹¦åè¿‡çŸ­"
        fi
        
        # æ£€æŸ¥ä¹¦åæ˜¯å¦å…¨æ˜¯æ•°å­—
        if [[ "$book_title" =~ ^[0-9]+$ ]]; then
            echo "  âŒ ä¹¦åå…¨æ˜¯æ•°å­—"
            unreasonable=true
            reason="ä¹¦åå…¨æ˜¯æ•°å­—"
        fi
        
        # æ£€æŸ¥æ˜¯å¦åŒ…å«å¹¿å‘Šæˆ–æ ‡ç­¾å­—æ ·
        if [[ "$book_title" =~ "æ›´å¤šç« èŠ‚" || "$book_title" =~ "vip" || "$book_title" =~ "é¦–è®¢" || "$book_title" =~ "ç±»åˆ«ï¼š" ]]; then
            echo "  âŒ ä¹¦ååŒ…å«å¹¿å‘Šæˆ–æ ‡ç­¾å­—æ ·"
            unreasonable=true
            reason="åŒ…å«å¹¿å‘Šæˆ–æ ‡ç­¾å­—æ ·"
        fi
        
        if [ "$unreasonable" = true ]; then
            unreasonable_files+=("$file")
            echo "  âš ï¸ æ ‡è®°ä¸ºéœ€è¦é‡æ–°å¤„ç†"
            # å°†ä¸åˆç†çš„æ–‡ä»¶ä¿¡æ¯å†™å…¥æ–‡ä»¶ï¼ŒåŒ…æ‹¬åŸå› 
            echo "$file:$reason" >> "$unreasonable_file_list"
        else
            reasonable_files+=("$file")
            echo "  âœ… å‘½ååˆç†"
        fi
    fi
done

echo ""
echo "é‡å‘½åè´¨é‡æ£€æŸ¥ç»“æœ:"
echo "  åˆç†å‘½å: ${#reasonable_files[@]} ä¸ª"
echo "  éœ€è¦é‡æ–°å¤„ç†: ${#unreasonable_files[@]} ä¸ª"

echo ""
echo "åˆç†å‘½åçš„æ–‡ä»¶:"
for file in "${reasonable_files[@]}"; do
    echo "  âœ“ $file"
done

echo ""
echo "éœ€è¦é‡æ–°å¤„ç†çš„æ–‡ä»¶ (å·²ä¿å­˜åˆ° $unreasonable_file_list):"
for file in "${unreasonable_files[@]}"; do
    echo "  âœ— $file"
done

cd ..
```

### æ­¥éª¤4ï¼šæ‰‹åŠ¨å¤„ç†å¼‚å¸¸æ–‡ä»¶

```bash
# æ­¥éª¤4.1ï¼šå¤„ç†ä¸åˆç†å‘½åå’Œæœªèƒ½è‡ªåŠ¨æå–ä¹¦åçš„æ–‡ä»¶
echo ""
echo "=== æ‰‹åŠ¨å¤„ç†å¼‚å¸¸æ–‡ä»¶ ==="

cd "temp_renaming" 2>/dev/null || exit

# æ£€æŸ¥æ˜¯å¦æœ‰å¼‚å¸¸æ–‡ä»¶åˆ—è¡¨
unreasonable_file_list="unreasonable_files.txt"
if [ -f "$unreasonable_file_list" ]; then
    echo "å‘ç°å¼‚å¸¸æ–‡ä»¶åˆ—è¡¨ï¼š$unreasonable_file_list"
    
    # è¯»å–éœ€è¦å¤„ç†çš„æ–‡ä»¶åˆ—è¡¨
    while IFS=':' read -r filename reason || [ -n "$filename" ]; do
        if [ -f "$filename" ]; then
            echo ""
            echo "=========================================="
            echo "å¤„ç†å¼‚å¸¸æ–‡ä»¶: $filename"
            echo "å¼‚å¸¸åŸå› : $reason"
            echo "=========================================="
            
            # æ˜¾ç¤ºæ–‡ä»¶è¯¦ç»†å†…å®¹
            echo "æ–‡ä»¶å†…å®¹é¢„è§ˆ:"
            python ../tools/txt_preview.py "$filename" 2000
            
            echo ""
            echo "è¯·é€‰æ‹©å¤„ç†æ–¹å¼ï¼š"
            echo "1) æ‰‹åŠ¨è¾“å…¥ä¹¦åå’Œä½œè€…è¿›è¡Œé‡å‘½å"
            echo "2) è·³è¿‡æ­¤æ–‡ä»¶ï¼ˆä¿æŒåŸåï¼‰"
            echo "3) æ ‡è®°ä¸ºæ— æ³•å¤„ç†"
            
            read -p "è¯·é€‰æ‹© (1-3): " choice
            
            case $choice in
                1)
                    read -p "è¯·è¾“å…¥ä¹¦å: " book_title
                    read -p "è¯·è¾“å…¥ä½œè€… (å¯é€‰): " author_name
                    
                    if [ ! -z "$book_title" ]; then
                        if [ ! -z "$author_name" ]; then
                            new_name="ã€Š${book_title}ã€‹ä½œè€…ï¼š${author_name}.txt"
                        else
                            new_name="ã€Š${book_title}ã€‹.txt"
                        fi
                        
                        # å¤„ç†é‡å¤æ–‡ä»¶å
                        if [ -f "$new_name" ]; then
                            counter=2
                            original_name="$new_name"
                            while [ -f "$new_name" ]; do
                                if [ ! -z "$author_name" ]; then
                                    new_name="ã€Š${book_title}ã€‹ä½œè€…ï¼š${author_name}(${counter}).txt"
                                else
                                    new_name="ã€Š${book_title}(${counter})ã€‹.txt"
                                end
                                counter=$((counter + 1))
                            done
                        fi
                        
                        mv "$filename" "$new_name"
                        echo "âœ… é‡å‘½åæˆåŠŸ: $new_name"
                    fi
                    ;;
                2)
                    echo "â­ï¸  ä¿æŒåŸæ–‡ä»¶å: $filename"
                    ;;
                3)
                    mv "$filename" "æ— æ³•å¤„ç†_${filename}"
                    echo "ğŸ·ï¸  æ ‡è®°ä¸ºæ— æ³•å¤„ç†: æ— æ³•å¤„ç†_${filename}"
                    ;;
            esac
        else
            echo "âŒ æ–‡ä»¶ä¸å­˜åœ¨: $filename"
        fi
    done < "$unreasonable_file_list"
else
    echo "æœªæ‰¾åˆ°å¼‚å¸¸æ–‡ä»¶åˆ—è¡¨ï¼Œå°†æ‰«ææœªå‘½åä¸ºã€Šä¹¦åã€‹æ ¼å¼çš„æ–‡ä»¶..."
    
    # æŸ¥æ‰¾æ‰€æœ‰æ•°å­—å‘½åæˆ–ä¸æ˜¯ã€Šã€‹æ ¼å¼çš„æ–‡ä»¶
    unprocessed_files=($(ls -1 | grep -v "^ã€Š.*ã€‹" | grep -v "æ— æ³•å¤„ç†_" | grep -E "\.txt$|\.TXT$"))
    
    if [ ${#unprocessed_files[@]} -gt 0 ]; then
        echo "å‘ç° ${#unprocessed_files[@]} ä¸ªéœ€è¦å¤„ç†çš„æ–‡ä»¶"
        
        for file in "${unprocessed_files[@]}"; do
            echo ""
            echo "=========================================="
            echo "æ‰‹åŠ¨å¤„ç†æ–‡ä»¶: $file"
            echo "=========================================="
            
            # æ˜¾ç¤ºæ–‡ä»¶è¯¦ç»†å†…å®¹
            echo "æ–‡ä»¶å†…å®¹é¢„è§ˆ:"
            python ../tools/txt_preview.py "$file" 2000
            
            echo ""
            echo "è¯·é€‰æ‹©å¤„ç†æ–¹å¼ï¼š"
            echo "1) æ‰‹åŠ¨è¾“å…¥ä¹¦åå’Œä½œè€…è¿›è¡Œé‡å‘½å"
            echo "2) è·³è¿‡æ­¤æ–‡ä»¶ï¼ˆä¿æŒåŸåï¼‰"
            echo "3) æ ‡è®°ä¸ºæ— æ³•å¤„ç†"
            
            read -p "è¯·é€‰æ‹© (1-3): " choice
            
            case $choice in
                1)
                    read -p "è¯·è¾“å…¥ä¹¦å: " book_title
                    read -p "è¯·è¾“å…¥ä½œè€… (å¯é€‰): " author_name
                    
                    if [ ! -z "$book_title" ]; then
                        if [ ! -z "$author_name" ]; then
                            new_name="ã€Š${book_title}ã€‹ä½œè€…ï¼š${author_name}.txt"
                        else
                            new_name="ã€Š${book_title}ã€‹.txt"
                        fi
                        
                        # å¤„ç†é‡å¤æ–‡ä»¶å
                        if [ -f "$new_name" ]; then
                            counter=2
                            original_name="$new_name"
                            while [ -f "$new_name" ]; do
                                if [ ! -z "$author_name" ]; then
                                    new_name="ã€Š${book_title}ã€‹ä½œè€…ï¼š${author_name}(${counter}).txt"
                                else
                                    new_name="ã€Š${book_title}(${counter})ã€‹.txt"
                                end
                                counter=$((counter + 1))
                            done
                        fi
                        
                        mv "$file" "$new_name"
                        echo "âœ… é‡å‘½åæˆåŠŸ: $new_name"
                    fi
                    ;;
                2)
                    echo "â­ï¸  ä¿æŒåŸæ–‡ä»¶å: $file"
                    ;;
                3)
                    mv "$file" "æ— æ³•å¤„ç†_${file}"
                    echo "ğŸ·ï¸  æ ‡è®°ä¸ºæ— æ³•å¤„ç†: æ— æ³•å¤„ç†_${file}"
                    ;;
            esac
        done
    else
        echo "âœ… æ‰€æœ‰æ–‡ä»¶å·²å¤„ç†å®Œæˆ"
    fi
fi

# ç»Ÿè®¡å¤„ç†ç»“æœ
renamed_files=($(ls ã€Š*ã€‹*.txt 2>/dev/null))
unprocessed_files=($(ls -1 | grep -v "^ã€Š.*ã€‹" | grep -v "æ— æ³•å¤„ç†_" | grep -E "\.txt$|\.TXT$"))
failed_files=($(ls æ— æ³•å¤„ç†_*.txt 2>/dev/null))

echo ""
echo "æ‰‹åŠ¨å¤„ç†ç»“æœç»Ÿè®¡:"
echo "  æˆåŠŸå‘½å: ${#renamed_files[@]} ä¸ªæ–‡ä»¶"
echo "  ä¿æŒåŸå: ${#unprocessed_files[@]} ä¸ªæ–‡ä»¶"
echo "  æ— æ³•å¤„ç†: ${#failed_files[@]} ä¸ªæ–‡ä»¶"

cd ..
```

### æ­¥éª¤5ï¼šæ•´ç†ç»“æœå’Œç”ŸæˆæŠ¥å‘Š

```bash
# æ­¥éª¤5.1ï¼šæ•´ç†å¤„ç†ç»“æœ
echo ""
echo "=== æ•´ç†å¤„ç†ç»“æœ ==="

if [ -d "$temp_dir" ];then
    cd "$temp_dir"
    
    # ç»Ÿè®¡æœ€ç»ˆç»“æœ
    final_renamed_files=($(ls ã€Š*ã€‹.txt 2>/dev/null))
    final_unprocessed_files=($(ls [0-9]*.txt [0-9]*.TXT ?.txt ?.TXT 2>/dev/null | grep -v "ã€Š" | grep -v "æ— æ³•å¤„ç†"))
    final_failed_files=($(ls æ— æ³•å¤„ç†_*.txt 2>/dev/null))
    
    echo "å¤„ç†ç»“æœç»Ÿè®¡:"
    echo "  æˆåŠŸé‡å‘½å: ${#final_renamed_files[@]} ä¸ªæ–‡ä»¶"
    echo "  ä¿æŒåŸå: ${#final_unprocessed_files[@]} ä¸ªæ–‡ä»¶"
    echo "  æ— æ³•å¤„ç†: ${#final_failed_files[@]} ä¸ªæ–‡ä»¶"
    
    # å°†å¤„ç†å¥½çš„æ–‡ä»¶ç§»å›ä¸»ç›®å½•
    echo ""
    echo "=== ç§»åŠ¨å¤„ç†å¥½çš„æ–‡ä»¶ ==="
    
    for file in "${final_renamed_files[@]}"; do
        if [ -f "$file" ];then
            # æ£€æŸ¥ä¸»ç›®å½•æ˜¯å¦å·²æœ‰åŒåæ–‡ä»¶
            if [ -f "../$file" ]; then
                echo "âš ï¸  ä¸»ç›®å½•å·²å­˜åœ¨: $fileï¼Œè·³è¿‡ç§»åŠ¨"
            else
                mv "$file" "../"
                echo "âœ… ç§»åŠ¨æˆåŠŸ: $file"
            fi
        fi
    done
    
    # å¤„ç†ä¿æŒåŸåçš„æ–‡ä»¶
    for file in "${final_unprocessed_files[@]}"; do
        if [ -f "$file" ];then
            if [ -f "../$file" ]; then
                echo "âš ï¸  ä¸»ç›®å½•å·²å­˜åœ¨: $fileï¼Œè·³è¿‡ç§»åŠ¨"
            else
                mv "$file" "../"
                echo "ğŸ“„ ä¿æŒåŸå: $file"
            fi
        fi
    done
    
    cd ..
    
    # æ¸…ç†ä¸´æ—¶ç›®å½•
    echo ""
    read -p "æ˜¯å¦åˆ é™¤ä¸´æ—¶ç›®å½•ï¼Ÿ(y/n): " cleanup_temp
    if [[ $cleanup_temp =~ ^[Yy]$ ]]; then
        rm -rf "$temp_dir"
        echo "âœ… ä¸´æ—¶ç›®å½•å·²æ¸…ç†"
    else
        echo "â„¹ï¸  ä¸´æ—¶ç›®å½•ä¿ç•™: $temp_dir"
    fi
fi

# ç”Ÿæˆå¤„ç†æŠ¥å‘Š
echo ""
echo "=== ç”Ÿæˆå¤„ç†æŠ¥å‘Š ==="
report_file="å¼‚å¸¸æ–‡ä»¶åä¿®å¤æŠ¥å‘Š_$(date +%Y%m%d_%H%M%S).txt"
{
    echo "å¼‚å¸¸æ–‡ä»¶åä¿®å¤å·¥ä½œæµå¤„ç†æŠ¥å‘Š"
    echo "å¤„ç†æ—¶é—´: $(date)"
    echo "å¤„ç†ç›®å½•: $(pwd)"
    echo ""
    echo "å¤„ç†ç»“æœç»Ÿè®¡:"
    echo "- æˆåŠŸé‡å‘½å: ${#final_renamed_files[@]} ä¸ªæ–‡ä»¶"
    echo "- ä¿æŒåŸå: ${#final_unprocessed_files[@]} ä¸ªæ–‡ä»¶"
    echo "- æ— æ³•å¤„ç†: ${#final_failed_files[@]} ä¸ªæ–‡ä»¶"
    echo ""
    echo "æˆåŠŸé‡å‘½åçš„æ–‡ä»¶åˆ—è¡¨:"
    for file in "${final_renamed_files[@]}"; do
        echo "  âœ… $file"
    done
    echo ""
    if [ ${#final_unprocessed_files[@]} -gt 0 ];then
        echo "ä¿æŒåŸåæ–‡ä»¶åˆ—è¡¨:"
        for file in "${final_unprocessed_files[@]}"; do
            echo "  ğŸ“„ $file"
        done
        echo ""
    fi
    if [ ${#final_failed_files[@]} -gt 0 ]; then
        echo "æ— æ³•å¤„ç†æ–‡ä»¶åˆ—è¡¨:"
        for file in "${final_failed_files[@]}"; do
            echo "  âŒ $file"
        done
    fi
} > "$report_file"

echo "âœ… å¤„ç†æŠ¥å‘Šå·²ç”Ÿæˆ: $report_file"
```

## ğŸ”§ é«˜çº§å¤„ç†æŠ€å·§

### 1. ä¹¦åæå–è§„åˆ™ä¼˜åŒ–

```bash
# æ”¹è¿›çš„ä¹¦åè¯†åˆ«æ¨¡å¼
extract_book_title_advanced() {
    local file="$1"
    
    echo "=== é«˜çº§ä¹¦åæå–: $file ==="
    
    # ä½¿ç”¨Pythonè„šæœ¬è¿›è¡Œé«˜çº§ä¹¦åæå–
    python -c "
import re
import sys

def extract_title_and_author(content):
    patterns = [
        # æ ‡å‡†æ ¼å¼ï¼šã€Šä¹¦åã€‹ä½œè€…ï¼šXXX
        r'ã€Š(.+?)ã€‹\s*ä½œè€…[ï¼š:\s]*(.+?)[\n\r]',
        # ä¹¦åï¼šXXX ä½œè€…ï¼šXXX
        r'ä¹¦å[ï¼š:\s]*(.+?)\s*ä½œè€…[ï¼š:\s]*(.+?)[\n\r]',
        # ç¯‡åï¼šXXX è‘—è€…ï¼šXXX
        r'ç¯‡å[ï¼š:\s]*(.+?)\s*è‘—è€…?[ï¼š:\s]*(.+?)[\n\r]',
        # ä½œå“åï¼šXXX ä½œè€…ï¼šXXX
        r'ä½œå“å[ï¼š:\s]*(.+?)\s*ä½œè€…[ï¼š:\s]*(.+?)[\n\r]',
        # ç¬¬ä¸€è¡ŒåŒ…å«ä¹¦åçš„æƒ…å†µ
        r'^(.+?)\s*ä½œè€…[ï¼š:\s]*(.+?)$',
        # ä»…ä¹¦åæ¨¡å¼
        r'ã€Š(.+?)ã€‹',
        r'ä¹¦å[ï¼š:\s]*(.+?)[\n\r]',
        r'ç¯‡å[ï¼š:\s]*(.+?)[\n\r]'
    ]
    
    for pattern in patterns:
        matches = re.findall(pattern, content, re.MULTILINE | re.IGNORECASE)
        if matches:
            if len(matches[0]) == 2:  # åŒ…å«ä½œè€…ä¿¡æ¯
                title, author = matches[0]
                return title.strip(), author.strip()
            else:  # ä»…ä¹¦å
                return matches[0].strip(), ''
    
    return None, None

try:
    with open('$file', 'r', encoding='utf-8', errors='ignore') as f:
        content = f.read(2000)  # è¯»å–å‰2000å­—ç¬¦
    
    title, author = extract_title_and_author(content)
    
    if title:
        print(f'æå–ä¹¦å: {title}')
        if author:
            print(f'æå–ä½œè€…: {author}')
        else:
            print('æœªæå–åˆ°ä½œè€…ä¿¡æ¯')
    else:
        print('æœªèƒ½æå–ä¹¦å')
        
except Exception as e:
    print(f'æå–å¤±è´¥: {e}')
"
}
```

### 2. æ–‡ä»¶ååˆç†æ€§æ£€æŸ¥

```bash
# æ–‡ä»¶ååˆç†æ€§æ£€æŸ¥å‡½æ•°
check_filename_reasonableness() {
    local filename="$1"
    local score=0
    local issues=()
    
    # æå–ä¹¦åéƒ¨åˆ†
    book_title=$(echo "$filename" | sed 's/ã€Š\(.*\)ã€‹\.txt/\1/' | sed 's/-.*$//')
    
    echo "æ£€æŸ¥æ–‡ä»¶å: $filename"
    echo "æå–ä¹¦å: $book_title"
    
    # æ£€æŸ¥é¡¹ç›®1ï¼šé•¿åº¦åˆç†æ€§
    if [ ${#book_title} -ge 2 ] && [ ${#book_title} -le 20 ]; then
        score=$((score + 1))
        echo "  âœ… é•¿åº¦åˆç† (${#book_title}å­—ç¬¦)"
    else
        issues+=("é•¿åº¦å¼‚å¸¸")
        echo "  âŒ é•¿åº¦å¼‚å¸¸ (${#book_title}å­—ç¬¦)"
    fi
    
    # æ£€æŸ¥é¡¹ç›®2ï¼šå­—ç¬¦åˆç†æ€§
    if [[ ! "$book_title" =~ [0-9]{3,} ]] && [[ ! "$book_title" =~ [ï¿½\?\*\<\>\|] ]]; then
        score=$((score + 1))
        echo "  âœ… å­—ç¬¦åˆç†"
    else
        issues+=("å­—ç¬¦å¼‚å¸¸")
        echo "  âŒ åŒ…å«å¼‚å¸¸å­—ç¬¦"
    fi
    
    # æ£€æŸ¥é¡¹ç›®3ï¼šä¸­æ–‡å­—ç¬¦æ¯”ä¾‹
    chinese_chars=$(echo "$book_title" | grep -o "[\u4e00-\u9fff]" | wc -l)
    total_chars=${#book_title}
    if [ $total_chars -gt 0 ];then
        chinese_ratio=$((chinese_chars * 100 / total_chars))
        if [ $chinese_ratio -ge 50 ];then
            score=$((score + 1))
            echo "  âœ… ä¸­æ–‡å­—ç¬¦æ¯”ä¾‹åˆç† (${chinese_ratio}%)"
        else
            issues+=("ä¸­æ–‡å­—ç¬¦è¿‡å°‘")
            echo "  âŒ ä¸­æ–‡å­—ç¬¦è¿‡å°‘ (${chinese_ratio}%)"
        fi
    fi
    
    # ç»¼åˆè¯„ä¼°
    if [ $score -ge 2 ];then
        echo "  ğŸ“Š æ€»ä½“è¯„ä¼°: åˆç† (å¾—åˆ†: $score/3)"
        return 0
    else
        echo "  ğŸ“Š æ€»ä½“è¯„ä¼°: ä¸åˆç† (å¾—åˆ†: $score/3)"
        echo "  é—®é¢˜: ${issues[*]}"
        return 1
    fi
}
```

### 3. æ‰¹é‡å†…å®¹åˆ†æ

```bash
# æ‰¹é‡åˆ†ææ–‡ä»¶å†…å®¹ç‰¹å¾
analyze_content_patterns() {
    echo "=== æ‰¹é‡å†…å®¹æ¨¡å¼åˆ†æ ==="
    
    for file in *.txt *.TXT; do
        if [ -f "$file" ] && [[ ! "$file" =~ ^ã€Š.*ã€‹\.txt$ ]]; then
            echo ""
            echo "åˆ†ææ–‡ä»¶: $file"
            
            # æå–æ–‡ä»¶å…³é”®ä¿¡æ¯
            python -c "
import re

try:
    with open('$file', 'r', encoding='utf-8', errors='ignore') as f:
        content = f.read(1000)
    
    # ç»Ÿè®¡æ–‡ä»¶ç‰¹å¾
    lines = content.split('\n')
    first_line = lines[0] if lines else ''
    
    # æŸ¥æ‰¾å¯èƒ½çš„æ ‡é¢˜è¡Œ
    title_patterns = [
        r'ç¬¬.{1,3}ç« ',  # ç« èŠ‚æ ‡é¢˜
        r'åº[ç« è¨€]',     # åºç« /åºè¨€
        r'æ¥”å­',        # æ¥”å­
        r'å‰è¨€',        # å‰è¨€
        r'å¼•å­'         # å¼•å­
    ]
    
    has_chapters = any(re.search(pattern, content) for pattern in title_patterns)
    
    print(f'é¦–è¡Œ: {first_line[:50]}...')
    print(f'åŒ…å«ç« èŠ‚: {\"æ˜¯\" if has_chapters else \"å¦\"}')
    print(f'å†…å®¹é•¿åº¦: {len(content)} å­—ç¬¦')
    
    # ç®€å•çš„ç±»å‹æ¨æ–­
    if 'ç¬¬ä¸€ç« ' in content or 'ç¬¬1ç« ' in content:
        print('æ¨æµ‹ç±»å‹: é•¿ç¯‡å°è¯´')
    elif any(word in content for word in ['è¯—', 'è¯', 'èµ‹']):
        print('æ¨æµ‹ç±»å‹: è¯—è¯ä½œå“')
    elif len(content) < 500:
        print('æ¨æµ‹ç±»å‹: çŸ­æ–‡æˆ–ç‰‡æ®µ')
    else:
        print('æ¨æµ‹ç±»å‹: ä¸­é•¿ç¯‡ä½œå“')
        
except Exception as e:
    print(f'åˆ†æå¤±è´¥: {e}')
"
        fi
    done
}
```

## âš ï¸ æ³¨æ„äº‹é¡¹å’Œæœ€ä½³å®è·µ

### å¤„ç†åŸåˆ™
1. **å®‰å…¨ç¬¬ä¸€**ï¼šæ‰€æœ‰æ“ä½œåœ¨ä¸´æ—¶ç›®å½•ä¸­è¿›è¡Œï¼Œé¿å…æ„å¤–è¦†ç›–
2. **å†…å®¹ä¸ºå‡†**ï¼šé‡å‘½åå¿…é¡»åŸºäºæ–‡ä»¶å®é™…å†…å®¹ï¼Œä¸èƒ½ä»…å‡­æ¨æµ‹
3. **äººå·¥ç¡®è®¤**ï¼šå¯¹äºä¸ç¡®å®šçš„æƒ…å†µï¼Œå¿…é¡»äººå·¥ç¡®è®¤
4. **å¤‡ä»½é‡è¦**ï¼šå¤„ç†å‰å¤‡ä»½é‡è¦æ–‡ä»¶

### è´¨é‡æ§åˆ¶
1. **é€ä¸€æ£€æŸ¥**ï¼šæ¯ä¸ªé‡å‘½åçš„æ–‡ä»¶éƒ½è¦æ£€æŸ¥åˆç†æ€§
2. **å†…å®¹åŒ¹é…**ï¼šç¡®ä¿æ–°æ–‡ä»¶åä¸å†…å®¹ç›¸ç¬¦
3. **ç¼–ç ç»Ÿä¸€**ï¼šæ‰€æœ‰æ–‡ä»¶ç»Ÿä¸€ä¸ºUTF-8ç¼–ç 
4. **æ ¼å¼è§„èŒƒ**ï¼šä¸¥æ ¼æŒ‰ç…§ã€Šä¹¦å-ä½œè€…ã€‹.txtæ ¼å¼å‘½å

### æ•ˆç‡æå‡
1. **åˆ†æ‰¹å¤„ç†**ï¼šå¤§é‡æ–‡ä»¶åˆ†æ‰¹å¤„ç†ï¼Œé¿å…ç–²åŠ³
2. **æ¨¡å¼å­¦ä¹ **ï¼šè®°å½•å¸¸è§çš„ä¹¦åæå–æ¨¡å¼
3. **å·¥å…·ä¼˜åŒ–**ï¼šæ ¹æ®å¤„ç†ç»éªŒä¼˜åŒ–æå–è§„åˆ™

## ğŸš¨ å¸¸è§é—®é¢˜è§£å†³

### é—®é¢˜1ï¼šç¼–ç ä¿®å¤å¤±è´¥
```bash
# æ‰‹åŠ¨ç¼–ç ä¿®å¤
manual_encoding_fix() {
    local file="$1"
    echo "æ‰‹åŠ¨ä¿®å¤ç¼–ç : $file"
    
    # å°è¯•ä¸åŒç¼–ç 
    for encoding in gbk gb2312 big5 gb18030; do
        echo "å°è¯•ç¼–ç : $encoding"
        python -c "
try:
    with open('$file', 'r', encoding='$encoding') as f:
        content = f.read()
    with open('${file}_temp', 'w', encoding='utf-8') as f:
        f.write(content)
    print('æˆåŠŸè½¬æ¢ä¸ºUTF-8')
except Exception as e:
    print(f'è½¬æ¢å¤±è´¥: {e}')
"
        if [ -f "${file}_temp" ];then
            mv "${file}_temp" "$file"
            echo "âœ… ç¼–ç ä¿®å¤æˆåŠŸ"
            break
        fi
    done
}
```

### é—®é¢˜2ï¼šä¹¦åæå–å¤±è´¥
```bash
# å¢å¼ºä¹¦åæå–
enhanced_title_extraction() {
    local file="$1"
    echo "å¢å¼ºä¹¦åæå–: $file"
    
    # æ˜¾ç¤ºæ›´å¤šå†…å®¹ä¾›åˆ†æ
    echo "æ–‡ä»¶å¼€å¤´å†…å®¹:"
    head -20 "$file"
    
    echo ""
    echo "æœç´¢å¯èƒ½çš„æ ‡é¢˜æ¨¡å¼:"
    grep -n "ä¹¦å\|ç¯‡å\|ä½œå“\|ã€Š.*ã€‹" "$file" | head -5
    
    echo ""
    echo "è¯·æ ¹æ®ä¸Šè¿°ä¿¡æ¯æ‰‹åŠ¨ç¡®å®šä¹¦å"
}
```

## ğŸ“Š å·¥ä½œæµç¨‹æ•ˆæœè¯„ä¼°

### æˆåŠŸæŒ‡æ ‡
- **ç¼–ç ä¿®å¤æˆåŠŸç‡** = 100%
- **é‡å‘½åæˆåŠŸç‡** > 80%
- **å‘½ååˆç†æ€§** > 90%
- **ä¿¡æ¯å®Œæ•´æ€§** > 70%ï¼ˆåŒ…å«ä½œè€…ä¿¡æ¯ï¼‰

### è¯„ä¼°æŠ¥å‘Šç”Ÿæˆ

```bash
# ç”Ÿæˆè¯¦ç»†çš„å¤„ç†æŠ¥å‘Š
generate_detailed_report() {
    echo "=== ç”Ÿæˆå¼‚å¸¸æ–‡ä»¶åä¿®å¤æŠ¥å‘Š ==="
    
    report_file="å¼‚å¸¸æ–‡ä»¶åä¿®å¤æŠ¥å‘Š_$(date +%Y%m%d_%H%M%S).txt"
    
    {
        echo "å¼‚å¸¸æ–‡ä»¶åä¿®å¤å·¥ä½œæµå¤„ç†æŠ¥å‘Š"
        echo "å¤„ç†æ—¶é—´: $(date)"
        echo "å¤„ç†ç›®å½•: $(pwd)"
        echo ""
        
        echo "=== å¤„ç†ç»Ÿè®¡ ==="
        echo "åŸå§‹å¼‚å¸¸æ–‡ä»¶æ•°: ${#abnormal_files[@]}"
        echo "æˆåŠŸé‡å‘½åæ–‡ä»¶æ•°: ${#final_renamed_files[@]}"
        echo "ç¼–ç ä¿®å¤æ–‡ä»¶æ•°: ${#encoding_problem_files[@]}"
        echo "ä¿æŒåŸåæ–‡ä»¶æ•°: ${#final_unprocessed_files[@]}"
        echo "æ— æ³•å¤„ç†æ–‡ä»¶æ•°: ${#final_failed_files[@]}"
        echo ""
        
        echo "=== æˆåŠŸé‡å‘½åæ–‡ä»¶åˆ—è¡¨ ==="
        for file in "${final_renamed_files[@]}"; do
            echo "  âœ… $file"
        done
        echo ""
        
        if [ ${#final_unprocessed_files[@]} -gt 0 ];then
            echo "=== ä¿æŒåŸåæ–‡ä»¶åˆ—è¡¨ ==="
            for file in "${final_unprocessed_files[@]}"; do
                echo "  ğŸ“„ $file"
            done
            echo ""
        fi
        
        if [ ${#final_failed_files[@]} -gt 0 ];then
            echo "=== æ— æ³•å¤„ç†æ–‡ä»¶åˆ—è¡¨ ==="
            for file in "${final_failed_files[@]}"; do
                echo "  âŒ $file"
            done
        fi
        
    } > "$report_file"
    
    echo "âœ… å¤„ç†æŠ¥å‘Šå·²ç”Ÿæˆ: $report_file"
}
```

---

*æœ€åæ›´æ–°ï¼š2025å¹´6æœˆ17æ—¥*
*ç‰ˆæœ¬ï¼šv2.0*
*é€‚ç”¨å·¥å…·ï¼šencoding_fixer.py, novel_renamer.py, txt_preview.py*