# 小说文件AI手动分类工作流

## 概述

本工作流定义了一个由AI主导、用户监督的半自动小说文件分类流程。AI作为核心执行者，负责处理自动分类失败或需要二次确认的文件。流程的核心是通过AI对文件内容的深度分析，实现精准分类，并在此过程中不断学习和发现新的关键词，以优化整个分类系统。

## 角色与职责

- **AI助手 (执行者)**:
  - 负责执行本工作流中定义的所有自动化步骤。
  - 读取和分析文件内容。
  - 提出分类、关键词提取的建议。
  - 执行文件重命名、移动和日志记录等操作。
- **用户 (监督者)**:
  - 启动工作流。
  - 审查AI的分类决策和关键词提取结果。
  - 在AI无法决策或决策错误时提供指导。
  - 最终确认对关键词配置库的修改。

## 🛠️ 所需工具

### 核心脚本

所有脚本均位于项目的 `tools` 目录下，执行时需使用正确的相对路径，例如 `python tools/batch_processor.py`。

- `batch_processor.py`: 批量处理管理器，用于确定待处理的文件批次。
- `txt_preview.py`: 文件内容预览工具，支持提取开头片段和随机片段供AI分析。
- `novel_statistics.py`: 小说库统计工具，用于在处理完成后更新统计数据。
- `append_to_file.py`: 文件追加工具，支持格式化追加关键词和分类日志。
- `quick_log.py`: 快速记录工具，简化关键词和分类日志的记录操作。

### 配置文件与日志

- `config/keywords_config.yaml`: 系统的核心关键词配置文件。
- `小说库/new_keywords_discovered.txt`: AI在分类过程中发现的新关键词记录。
- `小说库/logs/manual_classification_log.txt`: 手动分类过程的详细日志。

## 🚀 AI执行工作流程

这是一个标准化的AI操作流程，旨在高效、准确地完成手动分类任务。

### 阶段1：环境初始化

1. **检查工作目录**: 确认 `小说库/00-二次确认/` 目录存在。如果不存在，则无法开始流程。
2. **创建分析目录**: 在 `小说库/00-二次确认/` 下创建 `analysis/` 子目录，用于存储预处理的内容片段。
3. **检查待处理文件**: 统计 `小说库/00-二次确认/` 目录下的 `.txt` 文件数量。如果为0，则流程结束。
4. **初始化日志与关键词文件**:
   - 确保 `小说库/logs/` 目录存在。
   - 检查 `小说库/new_keywords_discovered.txt` 文件是否存在，如果不存在，则创建并写入初始头部信息。

### 阶段2：全量内容提取与预处理

1. **执行批量处理器**: 运行 `python tools/batch_processor.py`。
2. **自动内容提取**: 脚本将自动为每个待处理文件调用 `tools/txt_preview.py`，提取内容片段。
3. **生成分析文件**: 每个原始 txt 文件对应生成一个分析文件，存储在 `小说库/00-二次确认/analysis/` 目录下。
4. **文件命名规则**: 分析文件与原文件名保持一致，便于AI识别对应关系。
5. **进度监控**: 显示处理进度、成功/失败统计，生成详细的处理报告。

### 阶段3：手动分析与分类决策

⚠️ **重要原则：必须进行纯人工分析，严禁使用任何自动化分类工具**

这些文件之所以进入二次确认阶段，正是因为自动分类系统无法准确判断其类型。因此，在此阶段必须依靠人工智能的理解能力和语义分析，而不能再依赖关键词匹配等自动化方法。

#### 3.1. 手动读取分析文件

- **逐一审查**: 依次打开 `小说库/00-二次确认/analysis/` 目录下的每个 txt 文件
- **深度阅读**: 仔细阅读每个分析文件中的完整内容，包括：
  - 文件元信息（原路径、文件大小等）
  - 开头2000字符的内容片段
  - 5个随机片段（每个约400字符）
- **禁止工具辅助**: 严禁使用任何基于关键词匹配的自动分类脚本或工具

#### 3.2. 纯人工内容分析与决策

1. **深度内容理解**: 基于完整的文本片段，进行语义层面的深度分析：

   - **文学风格**: 文本的叙述风格、语言特色、行文节奏
   - **世界观构建**: 作品的背景设定、时代背景、社会结构
   - **情节发展**: 故事的主线情节、冲突设置、发展模式
   - **角色塑造**: 主要人物的身份背景、能力设定、关系网络
   - **主题内核**: 作品表达的核心主题和价值观念
2. **多维度综合判断**:

   - **不依赖单一片段**: 综合分析开头和随机片段，避免偏概全
   - **识别混合类型**: 对于跨类型作品，判断其主要类型特征
   - **考虑时代因素**: 结合作品的创作时代和文学潮流进行判断
3. **分类决策原则**:

   - 基于对文本的整体理解做出分类决定
   - 从12个预设分类中选择最符合作品核心特征的类别
   - 记录详细的分类理由，说明判断依据
4. **新关键词发现**:

   - 在阅读过程中主动识别具有分类指示意义的词汇和短语
   - 区分核心特征词（高权重）和辅助特征词（中低权重）
   - 发现现有关键词库中缺失的重要分类线索

#### 3.3. 使用工具记录与文件操作

> **注意：** 所有决策必须经过深度思考，但可使用自动化工具提高记录效率

1. **使用工具记录新关键词**: 使用 `quick_log.py` 工具快速追加新关键词到发现文件：

   ```bash
   # 记录新关键词的快速命令
   python tools/quick_log.py 小说库 keywords "历史类" "- 广平郡、曲梁城：三国地名，用于识别历史小说"
   ```

   或使用更详细的 `append_to_file.py`：

   ```bash
   python tools/append_to_file.py 小说库/new_keywords_discovered.txt --type keywords \
     --title "小说标题" --category "06-历史" \
     --keywords "地名:广平郡,曲梁城;人物:阳球,王甫" \
     --reason "三国穿越题材，用于历史小说识别"
   ```
2. **使用工具记录分类日志**: 使用 `quick_log.py` 工具快速记录分类结果：

   ```bash
   # 记录分类结果的快速命令
   python tools/quick_log.py 小说库 classification \
     "文件名.txt" "小说标题" "06-历史" \
     "三国穿越题材，有历史人物和地名" \
     "广平郡,曲梁城,阳球,王甫" "已移动到历史分类"
   ```
3. **使用命令行移动文件**: 使用终端命令高效移动文件到对应分类目录：

   ```powershell
   # Windows PowerShell 示例
   Move-Item "小说库\00-二次确认\原文件名.txt" "小说库\06-历史\"
   ```

   ```bash
   # Linux/Mac 示例  
   mv "小说库/00-二次确认/原文件名.txt" "小说库/06-历史/"
   ```
4. **文件名清理**: 如需清理文件名中的评分标记，可在移动时直接重命名：

   ```powershell
   # 移动时重命名清理标记
   Move-Item "小说库\00-二次确认\小说名【得分过低 (8分)】.txt" "小说库\06-历史\小说名.txt"
   ```

### 阶段4：逐个手动处理所有文件

- 按照阶段3的方法，逐一手动分析和分类所有预处理文件
- 每个文件都必须经过完整的阅读、分析、决策、记录流程
- 禁止批量操作或使用任何自动化工具加速处理

### 阶段5：清理和统计验证

1. **自动清理**: 删除 `小说库/00-二次确认/analysis/` 目录及其所有内容。
2. **更新统计数据**: 执行 `python tools/novel_statistics.py`，重新生成整个小说库的统计报告，以反映最新的分类结果。
3. **抽样验证**: 随机抽取几本刚刚被分类的文件，再次使用 `txt_preview.py` 提取内容，并结合其所在分类目录，提请用户进行快速验证，以确保AI的分类逻辑符合预期。

### 阶段6：系统优化与关键词库更新

1. **分析新关键词**: 分析 `小说库/new_keywords_discovered.txt` 中的所有记录。
2. **提出更新建议**:
   - 统计高频出现的新关键词及其所属分类。
   - 生成一份 `config/keywords_config.yaml` 的更新建议。
   - 将此建议呈现给用户，等待用户审核确认。
3. **执行更新**: 在获得用户批准后，将新关键词及其权重更新到 `config/keywords_config.yaml` 文件中，从而提升未来自动分类的准确性。

## ⚠️ 注意事项与最佳实践

### 🚫 严禁使用的方法

- **禁止关键词匹配**: 严禁使用任何基于关键词匹配的自动分类方法
- **禁止自动化脚本**: 不得使用 `ai_classifier.py`等自动分类脚本
- **禁止批量处理**: 必须逐一手动分析每个文件，不得批量自动决策
- **禁止简化判断**: 不得仅基于文件名或单一片段做出分类决定

### ✅ 必须遵循的原则

- **深度人工分析**: 每个文件必须经过完整的人工阅读和理解
- **多维度综合判断**: 基于文学风格、世界观、情节等多个维度进行判断
- **详细记录理由**: 每个分类决定都必须记录详细的分析理由
- **质量优于速度**: 宁可处理慢一些，也要确保分类准确性

### 📋 操作规范

- **决策透明**: 在执行每一步操作时，都应清晰地记录分析、决策和执行过程
- **边界情况处理**: 当无法做出明确的分类决策时（例如，多个分类的特征都很明显），应暂停处理该文件，寻求更多信息或专业指导
- **持续改进**: 将发现的新关键词和分类经验记录下来，用于优化关键词库和分类标准
- **清理时机**: 仅在确认所有文件都已正确分类后，才执行 analysis 目录的清理操作
- **文件查看编码**: 在PowerShell中查看UTF-8编码的日志文件时，必须指定编码参数以避免乱码：
  ```powershell
  # 正确查看日志文件的方式
  Get-Content "小说库\new_keywords_discovered.txt" -Encoding UTF8
  Get-Content "小说库\logs\manual_classification_log.txt" -Encoding UTF8
  ```

## 🔧 工具使用示例

### 新的工作流调用方式

```bash
# 一键启动完整的内容提取和预处理流程
python tools/batch_processor.py

# 检查预处理结果
ls 小说库/00-二次确认/analysis/

# 完成分类后查看统计报告
python tools/novel_statistics.py
```

### 高效记录工具使用方法

```bash
# 快速记录新关键词
python tools/quick_log.py 小说库 keywords "历史类" "- 广平郡、曲梁城：三国地名"

# 快速记录分类结果
python tools/quick_log.py 小说库 classification \
  "文件名.txt" "小说标题" "06-历史" "分析理由" "新关键词" "处理状态"

# 详细格式化追加（可选）
python tools/append_to_file.py 小说库/new_keywords_discovered.txt \
  --type keywords --title "标题" --category "06-历史" \
  --keywords "地名:地名1,地名2;人物:人物1,人物2" --reason "详细理由"
```

### analysis 文件格式示例

每个分析文件包含：

- 原文件元信息（路径、大小、编码等）
- 提取的开头内容片段（3000字符）
- 多个随机内容片段（每个300字符）
- 提取时间和参数记录

### batch_processor.py 输出示例

```text
🔧 批量文件处理工作流
==================================================
配置信息：
  目标目录：小说库/00-二次确认/
  分析目录：小说库/00-二次确认/analysis/
  待处理文件：156 个
==================================================

📋 开始全量内容提取...
🔍 [1/156] 处理: 《骨傲天不需要妹妹》【得分过低 (8分)】.txt
🔍 [2/156] 处理: 《诡秘之主》（精校版全本）【得分过低 (10分)】.txt
...
✅ 内容提取完成！成功: 154 个，失败: 2 个

📈 处理报告已生成: 小说库/logs/batch_processing_report.txt
💡 请开始AI分析，完成后运行清理命令
```

---

*最后更新：2025年6月28日*
*版本：v2.1*
*核心思想：AI主导执行，用户监督确认*
*新增：随机片段提取功能，提高分类准确性*
